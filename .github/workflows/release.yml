name: Release Build

on:
  workflow_dispatch:
    inputs:
      board:
        description: 'é€‰æ‹©è¦ç¼–è¯‘çš„æ¿åž‹'
        required: true
        type: choice
        options:
          - esp32s3-terminal
      version:
        description: 'ç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)'
        required: true
        default: '1.0.0'
        type: string

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release ${{ inputs.board }}
    runs-on: ubuntu-latest
    container:
      image: espressif/idf:release-v5.5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get board variant info
        id: variant
        shell: bash
        run: |
          source $IDF_PATH/export.sh
          VARIANT_NAME=$(python scripts/release.py --list-boards --json | python -c "import json, sys; boards = json.load(sys.stdin); print(next((b['name'] for b in boards if b['board'] == '${{ inputs.board }}'), 'esp32s3-terminal'))")
          echo "name=$VARIANT_NAME" >> $GITHUB_OUTPUT

      - name: Build firmware
        shell: bash
        run: |
          source $IDF_PATH/export.sh
          python scripts/release.py ${{ inputs.board }} --name ${{ steps.variant.outputs.name }}

      - name: Prepare release files
        run: |
          mkdir -p release
          cp build/merged-binary.bin release/xiaozhi_${{ steps.variant.outputs.name }}_v${{ inputs.version }}.bin
          
          # åˆ›å»º flash è¯´æ˜Žæ–‡ä»¶
          cat > release/FLASH_INSTRUCTIONS.txt << EOF
          Xiaozhi ESP32S3 Terminal å›ºä»¶çƒ§å½•è¯´æ˜Ž
          ========================================
          
          æ¿åž‹: ${{ inputs.board }}
          ç‰ˆæœ¬: v${{ inputs.version }}
          
          çƒ§å½•å‘½ä»¤:
          esptool.py -p COM3 write_flash 0x0 xiaozhi_${{ steps.variant.outputs.name }}_v${{ inputs.version }}.bin
          
          æˆ–ä½¿ç”¨ ESP Flash Download Tool çƒ§å½•åˆ°åœ°å€ 0x0
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ inputs.version }}-${{ inputs.board }}
          name: Xiaozhi ${{ inputs.board }} v${{ inputs.version }}
          body: |
            ## ðŸŽ‰ Xiaozhi Firmware Release
            
            **æ¿åž‹**: ${{ inputs.board }}  
            **ç‰ˆæœ¬**: v${{ inputs.version }}  
            
            ### ðŸ“¦ å›ºä»¶è¯´æ˜Ž
            - å›ºä»¶æ–‡ä»¶: `xiaozhi_${{ steps.variant.outputs.name }}_v${{ inputs.version }}.bin`
            - åŠŸèƒ½æ‰©å±•ï¼š`æ·»åŠ æŒ‡ä»¤æ’­æ”¾SDå¡musicç›®å½•ä¸­çš„éŸ³ä¹`
            - çƒ§å½•åœ°å€: `0x0`
            
            ### ðŸ”§ ç¡¬ä»¶é…ç½®
            - **ä¸»æŽ§**: ESP32-S3-WROOM-1 N16R8 (16MB Flash, 8MB PSRAM)
            - **å±å¹•**: ST7789 320x240 TFT LCD (SPIæŽ¥å£)
            - **éº¦å…‹é£Ž**: MSM261S4030H0R (I2S MEMSéº¦å…‹é£Ž)
            - **æ‰¬å£°å™¨**: NS4168 (I2Sæ•°å­—åŠŸæ”¾)
            - **å­˜å‚¨**: SDå¡æ§½ (æ”¯æŒFAT32æ ¼å¼)
            - **æŒ‰é”®**: BOOTæŒ‰é’® (GPIO0)
            - **ç¡¬ä»¶å¼€æº**: [esp32s3-lvgl-terminal](https://github.com/CaddonThaw/esp32s3-lvgl-terminal/tree/recode/hardware)
            
            ### ðŸ“ çƒ§å½•æ–¹æ³•
            ä½¿ç”¨ [Flash Download Tool](https://github.com/CaddonThaw/xiaozhi-esp32/tree/main/main/boards/esp32s3-terminal/tools/esp32s3Flash) çƒ§å½•ã€‚

            ### ðŸŽµ éŸ³ä¹è½¬æ¢å·¥å…·
            ä½¿ç”¨ [Music Transformer](https://github.com/CaddonThaw/xiaozhi-esp32/tree/main/main/boards/esp32s3-terminal/tools/musicTransformer) å°†éŸ³ä¹æ–‡ä»¶è½¬æ¢ä¸º OGG/Opus æ ¼å¼ã€‚
            
            ### ðŸ“‚ è¯´æ˜Žæ–‡æ¡£
            è¯¦ç»†è¯´æ˜Žè¯·å‚è§ [ESP32S3 Terminal README](https://github.com/CaddonThaw/xiaozhi-esp32/tree/main/main/boards/esp32s3-terminal/README.md)ã€‚

          files: |
            release/*
          draft: false
          prerelease: false
